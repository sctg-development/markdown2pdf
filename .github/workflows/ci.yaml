name: CI

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-test-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner for space (Ubuntu)
        uses: sctg-development/clean-image-for-docker@v2
        # Optional parameters
        with:
          remove-development-tools: "false"
          remove-browsers: "true"
          remove-android: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libcairo2-dev libpango1.0-dev libfontconfig1-dev pkg-config
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja PyMuPDF
        run: |
          python3 -m pip install --break-system-packages meson ninja PyMuPDF
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Setup libpdfium environment variable
        run: |
          echo "LIBPDFIUM_PATH=$(pwd)/pdfium/lib/linux" >> $GITHUB_ENV

      - name: Setup Rust
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup default stable
          rustup component add rustfmt clippy
        env:
          CARGO_HOME: ${{ runner.temp }}/cargo_home

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Build
        run: cargo build --verbose

      # - name: Run tests (default features)
      #   run: cargo test --verbose

      - name: clean beforre running coverage
        run: |
          rm -rf target

      - name: Generate coverage (Tarpaulin)
        run: cargo tarpaulin --exclude-files 'src/bin/test_mermaid.rs' --out Xml --output-dir coverage

      - name: Upload cobertura artifact
        uses: actions/upload-artifact@v4
        with:
          name: cobertura
          path: coverage/cobertura.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/cobertura.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          CODECOV_SLUG: sctg-development/markdown2pdf

  build-macos-amd64:
    name: Build macOS (amd64)
    runs-on: macos-latest
    env:
      TARGET: x86_64-apple-darwin
      PKG_CONFIG_PATH: /usr/local/lib/pkgconfig:/opt/homebrew/lib/pkgconfig
    steps:
      - uses: actions/checkout@v6
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install Homebrew x86_64
        shell: bash
        run: |
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true
      - name: Install dependencies (x86_64)
        shell: bash
        run: |
          arch -x86_64 /usr/local/bin/brew install cairo pango fontconfig pkg-config lzo libffi zlib bzip2 graphite2 libpng freetype harfbuzz pixman pcre2
      - name: Verify pango installation
        shell: bash
        run: |
          arch -x86_64 /usr/local/bin/brew list pango
          arch -x86_64 /usr/local/bin/pkg-config --list-all | grep pango
      # install meson and nija with --break-system-packages
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Add target
        run: rustup target add $TARGET
      - name: Build (release for $TARGET)
        run: cargo build --all-features --release --target $TARGET --bin markdown2pdf
      - name: Note about tests
        run: |
          echo "Cross-compiling for $TARGET; running tests for the build target is not supported on this runner."

  build-macos-arm64:
    name: Build macOS (arm64)
    # This job targets a macOS arm64 runner (macos-latest is arm64).
    runs-on: macos-latest
    env:
      TARGET: aarch64-apple-darwin
      PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig
    steps:
      - name: Clean runner for Docker builds
        uses: sctg-development/clean-image-for-docker@docker-storage
        with:
          remove-development-tools: "true"
          remove-browsers: "true"
          remove-databases: "true"
          remove-cloud-tools: "true"
          show-top-packages: "true"
      - uses: actions/checkout@v6
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Install dependencies
        shell: bash
        run: |
          brew install cairo pango fontconfig pkg-config lzo libffi zlib bzip2 graphite2 libpng freetype harfbuzz pixman pcre2
      - name: Verify pango installation
        shell: bash
        run: |
          brew list pango
          pkg-config --list-all | grep pango
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Add target (aarch64)
        run: rustup target add $TARGET || true
      - name: Build (release for host)
        # Build for the native host architecture; explicit target available as $TARGET
        run: cargo build --all-features --release --target $TARGET --bin markdown2pdf
      - name: Run tests (host)
        # Tests run on the runner for the host arch
        run: cargo test --all-features --no-fail-fast
  build-windows:
    name: Build Windows (x86_64)
    runs-on: windows-latest
    env:
      TARGET: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Add target
        run: rustup target add ${{ env.TARGET }}
      - name: Install vcpkg
        shell: bash
        run: |
          if [ ! -d "C:/vcpkg" ]; then
            git clone https://github.com/Microsoft/vcpkg.git C:/vcpkg
            C:/vcpkg/bootstrap-vcpkg.bat
          fi
      - name: Install dependencies via vcpkg
        shell: bash
        run: |
          C:/vcpkg/vcpkg.exe install cairo:x64-windows pango:x64-windows fontconfig:x64-windows pkgconf:x64-windows libpng:x64-windows freetype:x64-windows harfbuzz:x64-windows pixman:x64-windows libffi:x64-windows pcre2:x64-windows zlib:x64-windows bzip2:x64-windows lzo:x64-windows
      - name: Set VCPKG_ROOT
        shell: bash
        run: echo "VCPKG_ROOT=C:/vcpkg" >> $GITHUB_ENV
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Build (release for ${{ env.TARGET }})
        run: cargo build --all-features --release --target ${{ env.TARGET }} --bin markdown2pdf
      - name: Note about tests
        run: |
          echo "Note: Tests for Windows are not run in CI at this time."

  docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libcairo2-dev libpango1.0-dev libfontconfig1-dev pkg-config
      # install meson and nija with --break-system-packages
      - name: Install meson and ninja
        run: |
          python3 -m pip install --break-system-packages meson ninja
      - name: Setup Rust
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup default stable
          rustup component add rustfmt clippy
        env:
          CARGO_HOME: ${{ runner.temp }}/cargo_home

      - name: Build docs
        shell: bash
        run: |
          export RUSTDOCFLAGS="--html-in-header ./doc_helper/mermaid-header.html --html-in-header ./doc_helper/github-corner.html"
          cargo doc --no-deps --document-private-items --all-features

      - name: Patch docs for GitHub project pages
        shell: bash
        run: |
          set -euo pipefail
          REPO=markdown2pdf
          ROOT=target/doc
          DOCDIR="$ROOT/$REPO"
          STATIC_DIR="$ROOT/static.files"
          echo "Doc dir: $DOCDIR, static dir: $STATIC_DIR"
          mkdir -p "$DOCDIR"
          # Copy common global assets into crate doc dir if present (JS, CSS, WASM, fonts)
          shopt -s nullglob
          for f in "$ROOT"/crates.js; do
            if [ -f "$f" ]; then
              echo "Copying $f to $DOCDIR/"
              cp -v "$f" "$DOCDIR"/
            fi
          done
          if [ -d "$STATIC_DIR" ]; then
            echo "Copying static assets from $STATIC_DIR to $DOCDIR/"
            cp -vr "$STATIC_DIR"/* "$DOCDIR"/
          fi
          # Also copy font files found in subdirectories
          find "$ROOT" -type f -name '*.woff2' -exec cp -v {} "$DOCDIR"/ \; || true

          # Fix absolute references in HTML/CSS/JS to point to project root
          # example: href="something/file.css" -> href="/repo/file.css"
          # Replace occurrences like "/crates.js" -> "/<repo>/crates.js", "/main-" -> "/<repo>/main-", and handle url('/...') and ../static.files/ patterns
          grep -RIl -e '"/crates.js' -e '"/main-' -e '"/normalize-' -e '"/rustdoc-' -e '"/storage-' -e 'SourceSerif4-' -e 'FiraSans-' -e 'SourceCodePro-' -e '\.\./static.files' -e 'static.files' "$DOCDIR" || true
          for file in $(grep -RIl -e '"/crates.js' -e '"/main-' -e '"/normalize-' -e '"/rustdoc-' -e '"/storage-' -e 'SourceSerif4-' -e 'FiraSans-' -e 'SourceCodePro-' -e '\.\./static.files' -e 'static.files' "$DOCDIR" || true); do
            # Remove ../static.files/ prefix generated by rustdoc and make references relative
            sed -ibak 's|\./\./static.files/||g' "$file"
            sed -ibak 's|\.\./static.files/||g' "$file"
            sed -ibak 's|"\.\./crates.js|"crates.js|g' "$file"
          done
          # Remove bak files
          find "$DOCDIR" -type f -name '*bak' -exec rm -f {} \;

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: target/doc/markdown2pdf

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
